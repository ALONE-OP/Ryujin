name: Build (MSVC) and Publish Release

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write

env:
  VCPKG_ROOT: ${{ github.workspace }}\vcpkg
  BUILD_CONFIG: Release
  PLATFORM: x64
  TRIPLET: x64-windows
  PLATFORM_TOOLSET: v143

jobs:
  build-windows-msvc:
    runs-on: windows-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1

      - name: Detect Windows SDK Version
        shell: pwsh
        run: |
          $includeRoot = 'C:\Program Files (x86)\Windows Kits\10\Include'
          if (Test-Path $includeRoot) {
            $versions = Get-ChildItem $includeRoot -Directory |
              Where-Object { $_.Name -match '^\d+(\.\d+)+' } |
              Select-Object -ExpandProperty Name
            if ($versions.Count -gt 0) {
              $best = $versions | Sort-Object {[version]$_} -Descending | Select-Object -First 1
              "WINDOWS_SDK_VERSION=$best" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
              Write-Host "Using SDK: $best"
            }
          }

      - name: Download & Bootstrap vcpkg
        shell: pwsh
        run: |
          $vroot = $env:VCPKG_ROOT
          if (Test-Path $vroot) { Remove-Item -Recurse -Force $vroot }

          $url = "https://github.com/microsoft/vcpkg/archive/refs/heads/master.zip"
          Invoke-WebRequest $url -OutFile "vcpkg.zip"
          Expand-Archive "vcpkg.zip" -DestinationPath "temp" -Force
          Move-Item "temp/vcpkg-master" $vroot
          Remove-Item "temp","vcpkg.zip" -Recurse -Force

          Set-Location $vroot
          .\bootstrap-vcpkg.bat

      - name: Install Dependencies (vcpkg manifest)
        shell: pwsh
        run: |
          $vcpkg = Join-Path $env:VCPKG_ROOT "vcpkg.exe"
          & $vcpkg integrate install

          Push-Location $env:GITHUB_WORKSPACE
          if (Test-Path "vcpkg.json") {
            Write-Host "Installing packages using manifest mode..."
            & $vcpkg install --triplet $env:TRIPLET
          }
          Pop-Location

      - name: Ensure imgs directory exists
        shell: pwsh
        run: |
          $imgs = Join-Path $env:GITHUB_WORKSPACE "imgs"
          if (-not (Test-Path $imgs)) { New-Item -ItemType Directory $imgs }

      - name: Build Solution (Release Only)
        shell: pwsh
        run: |
          $repo = $env:GITHUB_WORKSPACE
          $sln = Join-Path $repo "RyujinConsole\Ryujin Protector.sln"
          if (-not (Test-Path $sln)) { throw "Solution not found: $sln" }

          $args = @(
            $sln,
            "/p:Configuration=$env:BUILD_CONFIG",
            "/p:Platform=$env:PLATFORM",
            "/p:PlatformToolset=$env:PLATFORM_TOOLSET",
            "/p:VcpkgEnabled=true",
            "/p:VcpkgEnableManifest=true",
            "/p:VcpkgInstalledDir=$env:VCPKG_ROOT\installed\$env:TRIPLET",
            "/m"
          )

          if ($env:WINDOWS_SDK_VERSION) {
            $args += "/p:WindowsTargetPlatformVersion=$env:WINDOWS_SDK_VERSION"
          }

          & msbuild @args
          if ($LASTEXITCODE -ne 0) { throw "Release build failed!" }

      - name: Collect Release Binaries
        shell: pwsh
        run: |
          $repo = $env:GITHUB_WORKSPACE
          $out = Join-Path $repo "release_artifacts"

          if (Test-Path $out) { Remove-Item -Recurse -Force $out }
          New-Item -ItemType Directory $out

          Write-Host "Collecting exe/dll/lib/pdb files from Release directories..."

          $files = Get-ChildItem -Path $repo -Recurse -File |
            Where-Object {
              $_.FullName -match "Release" -and
              $_.Extension -match '\.(exe|dll|lib|pdb|exp)$' -and
              $_.FullName -notmatch '\\vcpkg\\'
            }

          foreach ($file in $files) {
            $dest = Join-Path $out $file.Name
            Copy-Item $file.FullName $dest -Force
            Write-Host "Collected: $($file.Name)"
          }

          $count = (Get-ChildItem $out).Count
          if ($count -eq 0) { throw "No Release binaries collected!" }

      - name: Create Release ZIP
        shell: pwsh
        run: |
          $repo = $env:GITHUB_WORKSPACE
          $zip = "ryujin-release-${{ github.sha }}.zip"
          $folder = Join-Path $repo "release_artifacts"

          if (Test-Path $zip) { Remove-Item $zip }
          Compress-Archive -Path "$folder\*" -DestinationPath $zip -Force

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: release-${{ github.sha }}
          name: "Ryujin Release ${{ github.sha }}"
          body: |
            Automated Release Build  
            Commit: ${{ github.sha }}  
            Mode: Release  
            Built on: ${{ github.event.head_commit.timestamp }}
          files: |
            ryujin-release-${{ github.sha }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
